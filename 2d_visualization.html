<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTR Knowledge Graph - 2D Visualization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #1a1a2e;
            color: white;
            overflow: hidden;
        }

        #mynetwork {
            width: 100%;
            height: 100vh;
            background-color: #1a1a2e;
        }

        /* Legend Panel */
        #legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 30, 50, 0.95);
            border: 2px solid #7A84DD;
            border-radius: 10px;
            padding: 15px 20px;
            z-index: 1000;
        }

        #legend h3 {
            margin: 0 0 12px 0;
            color: #8ACAE5;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .legend-label {
            font-size: 13px;
            color: #e0e0e0;
        }

        /* Info Panel */
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(30, 30, 50, 0.95);
            border: 2px solid #7A84DD;
            border-radius: 10px;
            padding: 20px;
            display: none;
            z-index: 1000;
        }

        #info-panel h3 {
            margin: 0 0 15px 0;
            color: #8ACAE5;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(122, 132, 221, 0.3);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .info-label {
            color: #888;
            font-weight: 500;
        }

        .info-value {
            color: #e0e0e0;
            font-weight: 400;
        }

        .info-connections {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(122, 132, 221, 0.3);
        }

        .info-connections h4 {
            color: #8ACAE5;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .connection-list {
            font-size: 12px;
            color: #aaa;
            max-height: 120px;
            overflow-y: auto;
        }

        .connection-item {
            padding: 3px 0;
        }

        /* Instructions Panel */
        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 30, 50, 0.95);
            border: 2px solid #7A84DD;
            border-radius: 10px;
            padding: 15px 20px;
            max-width: 220px;
            z-index: 1000;
        }

        #instructions h3 {
            margin: 0 0 10px 0;
            color: #8ACAE5;
            font-size: 14px;
            font-weight: 600;
        }

        #instructions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #instructions li {
            font-size: 12px;
            color: #aaa;
            margin: 6px 0;
            line-height: 1.4;
        }

        #instructions li strong {
            color: #e0e0e0;
        }

        /* Title */
        #title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 50, 0.95);
            border: 2px solid #7A84DD;
            border-radius: 10px;
            padding: 10px 25px;
            z-index: 1000;
        }

        #title h1 {
            font-size: 18px;
            color: #8ACAE5;
            font-weight: 600;
            margin: 0;
        }

        /* Scrollbar styling */
        .connection-list::-webkit-scrollbar {
            width: 6px;
        }

        .connection-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .connection-list::-webkit-scrollbar-thumb {
            background: #7A84DD;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="mynetwork"></div>

    <div id="title">
        <h1>Lord of the Rings - Character Network</h1>
    </div>

    <div id="instructions">
        <h3>How to Explore</h3>
        <ul>
            <li><strong>Hover</strong> over nodes to see details</li>
            <li><strong>Click</strong> a node to highlight connections</li>
            <li><strong>Click background</strong> to reset</li>
            <li><strong>Scroll</strong> to zoom in/out</li>
            <li><strong>Drag</strong> to pan the view</li>
        </ul>
    </div>

    <div id="info-panel">
        <h3 id="char-name">Character Name</h3>
        <div class="info-row">
            <span class="info-label">Race:</span>
            <span class="info-value" id="char-race">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Gender:</span>
            <span class="info-value" id="char-gender">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Appearances:</span>
            <span class="info-value" id="char-weight">-</span>
        </div>
        <div class="info-row">
            <span class="info-label">Connections:</span>
            <span class="info-value" id="char-connections">-</span>
        </div>
        <div class="info-connections">
            <h4>Strongest Connections</h4>
            <div class="connection-list" id="char-top-connections"></div>
        </div>
    </div>

    <div id="legend">
        <h3>Races</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #BD9267"></div>
            <span class="legend-label">Hobbits</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #7A84DD"></div>
            <span class="legend-label">Men</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8ACAE5"></div>
            <span class="legend-label">Elves</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #B15B60"></div>
            <span class="legend-label">Dwarves</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #3A7575"></div>
            <span class="legend-label">Ainur (Wizards)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #E3845D"></div>
            <span class="legend-label">Ents</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #020104"></div>
            <span class="legend-label">Orcs</span>
        </div>
    </div>

    <script>
        // ============================================
        // LOTR Knowledge Graph - 2D Visualization
        // Loads data from shared JSON file
        // ============================================

        // Race colors mapping (same as data_processor.py)
        const raceColors = {
            'men': '#7A84DD',
            'elves': '#8ACAE5',
            'hobbit': '#BD9267',
            'dwarf': '#B15B60',
            'ainur': '#3A7575',
            'ents': '#E3845D',
            'orcs': '#020104',
            'animal': '#8ACAE5'
        };

        // Race display names
        const raceNames = {
            'men': 'Men',
            'elves': 'Elves',
            'hobbit': 'Hobbit',
            'dwarf': 'Dwarf',
            'ainur': 'Ainur',
            'ents': 'Ent',
            'orcs': 'Orc',
            'animal': 'Animal'
        };

        // Global variables
        let nodesData = [];
        let edgesData = [];
        let nodeMap = {};
        let network = null;
        let nodes = null;
        let edges = null;
        let maxEdgeWeight = 1;

        // Load data from JSON and initialize
        async function init() {
            try {
                console.log('Loading graph data...');
                const response = await fetch('./lotr_graph.json');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Store data
                nodesData = data.nodes;
                edgesData = data.links.map(link => ({
                    from: link.source,
                    to: link.target,
                    weight: link.weight
                }));

                console.log(`Loaded ${nodesData.length} nodes and ${edgesData.length} edges`);
                console.log('Metadata:', data.metadata);

                // Create node lookup
                nodesData.forEach(n => nodeMap[n.id] = n);

                // Initialize the network
                initializeNetwork();

            } catch (error) {
                console.error('Error loading graph data:', error);
                document.getElementById('mynetwork').innerHTML = `
                    <div style="color: white; padding: 50px; text-align: center;">
                        <h2>Error Loading Data</h2>
                        <p>${error.message}</p>
                        <p>Make sure you're running a local server (npm start)</p>
                    </div>
                `;
            }
        }

        function initializeNetwork() {
            // Calculate node sizes based on weight
            const maxWeight = Math.max(...nodesData.map(n => n.weight));
            const minSize = 10;
            const maxSize = 50;

            // Build vis.js nodes
            nodes = new vis.DataSet(nodesData.map(node => ({
                id: node.id,
                label: node.label,
                color: {
                    background: raceColors[node.race] || '#7A84DD',
                    border: raceColors[node.race] || '#7A84DD',
                    highlight: {
                        background: '#046de7',
                        border: '#046de7'
                    },
                    hover: {
                        background: raceColors[node.race] || '#7A84DD',
                        border: '#ffffff'
                    }
                },
                size: minSize + (node.weight / maxWeight) * (maxSize - minSize),
                font: { color: 'white', size: 14 },
                shape: 'dot',
                borderWidth: 2,
                borderWidthSelected: 3
            })));

            // Build vis.js edges
            maxEdgeWeight = Math.max(...edgesData.map(e => e.weight));
            edges = new vis.DataSet(edgesData.map(edge => ({
                from: edge.from,
                to: edge.to,
                value: edge.weight,
                color: {
                    color: 'rgba(150, 150, 150, 0.4)',
                    highlight: '#046de7',
                    hover: 'rgba(150, 150, 150, 0.6)'
                },
                width: 1 + (edge.weight / maxEdgeWeight) * 3
            })));

            // Network options (Barnes-Hut physics - same as working version)
            const options = {
                physics: {
                    barnesHut: {
                        gravitationalConstant: -5000,
                        centralGravity: 0,
                        springLength: 200,
                        springConstant: 0.009,
                        damping: 0.025,
                        avoidOverlap: 0
                    },
                    stabilization: {
                        enabled: true,
                        iterations: 1000,
                        updateInterval: 50,
                        fit: true
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 0,
                    hideEdgesOnDrag: false,
                    hideNodesOnDrag: false
                },
                nodes: {
                    shape: 'dot'
                },
                edges: {
                    smooth: {
                        enabled: true,
                        type: 'continuous'
                    }
                }
            };

            // Create network
            const container = document.getElementById('mynetwork');
            network = new vis.Network(container, { nodes, edges }, options);

            // Disable physics after stabilization
            network.once('stabilizationIterationsDone', function() {
                network.setOptions({ physics: false });
                console.log('Stabilization complete - physics disabled');
            });

            // Set up event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Hover to show info
            network.on('hoverNode', function(params) {
                showInfoPanel(params.node);
            });

            network.on('blurNode', function() {
                hideInfoPanel();
            });

            // Click to highlight connections
            network.on('selectNode', function(params) {
                highlightConnections(params.nodes[0]);
            });

            network.on('deselectNode', function() {
                resetHighlight();
            });
        }

        // Get connections for a node (uses pre-computed data if available)
        function getNodeConnections(nodeId) {
            const connections = [];
            edgesData.forEach(edge => {
                if (edge.from === nodeId) {
                    connections.push({ id: edge.to, weight: edge.weight });
                } else if (edge.to === nodeId) {
                    connections.push({ id: edge.from, weight: edge.weight });
                }
            });
            return connections.sort((a, b) => b.weight - a.weight);
        }

        // Show info panel
        function showInfoPanel(nodeId) {
            const node = nodeMap[nodeId];
            if (!node) return;

            const connections = getNodeConnections(nodeId);

            document.getElementById('char-name').textContent = node.label;
            document.getElementById('char-race').textContent = raceNames[node.race] || node.race;
            document.getElementById('char-gender').textContent =
                node.gender ? node.gender.charAt(0).toUpperCase() + node.gender.slice(1) : '-';
            document.getElementById('char-weight').textContent = node.weight;
            document.getElementById('char-connections').textContent =
                node.total_connections !== undefined ? node.total_connections : connections.length;

            // Top 5 connections (use pre-computed strongest if available)
            const topConnections = connections.slice(0, 5);

            const connectionsHtml = topConnections.map(c => {
                const connNode = nodeMap[c.id];
                const label = connNode ? connNode.label : c.id;
                return `<div class="connection-item">${label} (${c.weight})</div>`;
            }).join('');
            document.getElementById('char-top-connections').innerHTML = connectionsHtml;

            document.getElementById('info-panel').style.display = 'block';
        }

        // Hide info panel
        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        // Highlight connections when clicking a node
        function highlightConnections(nodeId) {
            const connectedNodes = network.getConnectedNodes(nodeId);
            const connectedEdges = network.getConnectedEdges(nodeId);

            // Update all nodes
            const updatedNodes = nodesData.map(node => {
                if (node.id === nodeId || connectedNodes.includes(node.id)) {
                    return {
                        id: node.id,
                        opacity: 1,
                        color: {
                            background: node.id === nodeId ? '#046de7' : raceColors[node.race],
                            border: node.id === nodeId ? '#046de7' : raceColors[node.race]
                        }
                    };
                } else {
                    return {
                        id: node.id,
                        opacity: 0.2,
                        color: {
                            background: 'rgba(100,100,100,0.3)',
                            border: 'rgba(100,100,100,0.3)'
                        }
                    };
                }
            });
            nodes.update(updatedNodes);

            // Update all edges
            const allEdges = edges.get();
            const updatedEdges = allEdges.map(edge => {
                if (connectedEdges.includes(edge.id)) {
                    return {
                        id: edge.id,
                        color: { color: '#046de7', opacity: 0.8 },
                        width: 3
                    };
                } else {
                    return {
                        id: edge.id,
                        color: { color: 'rgba(150,150,150,0.1)' },
                        width: 1
                    };
                }
            });
            edges.update(updatedEdges);
        }

        // Reset highlight
        function resetHighlight() {
            // Reset nodes
            const resetNodes = nodesData.map(node => ({
                id: node.id,
                opacity: 1,
                color: {
                    background: raceColors[node.race] || '#7A84DD',
                    border: raceColors[node.race] || '#7A84DD',
                    highlight: {
                        background: '#046de7',
                        border: '#046de7'
                    }
                }
            }));
            nodes.update(resetNodes);

            // Reset edges
            const resetEdges = edges.get().map(edge => ({
                id: edge.id,
                color: {
                    color: 'rgba(150, 150, 150, 0.4)',
                    highlight: '#046de7'
                },
                width: 1 + (edge.value / maxEdgeWeight) * 3
            }));
            edges.update(resetEdges);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
